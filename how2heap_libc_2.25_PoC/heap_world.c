#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <malloc.h>

size_t *global_ptr = 0;
char bss_var[] = "This is global variable";

void memory_print(size_t* address, long size)
{
	int k=0;

	for(int i=0;i<size;i++ )
	{
		if(k==0){fprintf(stderr,"%018p : ", (address + i));}
		k++;
		fprintf(stderr, "0x%016lx ", *(address + i));
		if(k==4){fprintf(stderr,"\n");k=0;}
	}
}


int main(int argc, char* argv[])
{

	size_t stack_var_1[0x10];
	size_t stack_var_2[0x10];
	size_t *stack_ptr = 0;
	size_t *malloc_list[0x100];
	int malloc_index = 0;

	fprintf(stderr, "\nWelcome to Heap restaurant.");
	while(1)
	{

		int select_num = 0;

		fprintf(stderr, "\n1. heap menu\n2. global menu\n3. stack menu\n4. exit\nselect menu >");

		fscanf(stdin, "%d", &select_num);
		getchar();

		if(select_num == 1)
		{
			fprintf(stderr, "1. new chunk\n2. select chunk\nselect menu >");

			int select_num_1 = 0;
			fscanf(stdin, "%d", &select_num_1);
			getchar();

			if(select_num_1 == 1)
			{
				fprintf(stderr, "malloc size > ");
				long size = 0;
				fscanf(stdin, "%ld",&size);
				getchar();
				malloc_list[malloc_index] = malloc(size);
				malloc_index ++;
			}
			else if(select_num_1 == 2)
			{
				int index = 0;
				fprintf(stderr, "chunk index > ");
				fscanf(stdin, "%d", &index);
				long chunk_size = *(malloc_list[index] - 1) ;
				long usable_chunk_size = chunk_size & ~1;
				fprintf(stderr, "<Chunk %d>\nadress :%p\nprev_size : 0x%lx\nsize : 0x%lx\ndata :\n", index, malloc_list[index], *(malloc_list[index] - 2), chunk_size);
				int k=0;
				memory_print(malloc_list[index], (usable_chunk_size / 8) - 1);

				fprintf(stderr, "\n<end>\n\n");

				fprintf(stderr, "1. write data\n2. free\n3. main menu\nselect menu >");
				int select_num_1_2 = 0;
				fscanf(stdin, "%d", &select_num_1_2);
				getchar();
				if(select_num_1_2 == 1)
				{
					fprintf(stderr, "data > ");
					gets(malloc_list[index]);
				}
				else if(select_num_1_2 == 2)
				{
					free(malloc_list[index]);
					fprintf(stderr, "Free Chunk %d\n", index);
				}
				else if(select_num_1_2 == 3)
				{
					continue;
				}
				else
				{
					fprintf(stderr, "Pardon?\n");
					continue;
				}
			}
			else
			{
				fprintf(stderr, "Pardon?\n");
				continue;
			}
		}
		else if(select_num == 2)
		{	
			while(1){
				fprintf(stderr, "\n<global_ptr>\nAddress : %018p\nData : %018p\n<end>\n\n", &global_ptr, global_ptr);
				fprintf(stderr, "<bss_var>\nAddress : %018p\nData : %s\n<end>\n\n", &bss_var, bss_var);

				int select_num_2 = 0;

				fprintf(stderr, "1. global_ptr\n2. bss_var\n3. main menu\nselect > ");
				fscanf(stdin, "%d", &select_num_2);
				getchar();

				if(select_num_2 == 1)
				{
					fprintf(stderr, "Data > ");
					fscanf(stdin, "%s", &global_ptr);
					getchar();
					fprintf(stderr, "Done\n");
				}
				else if(select_num_2 == 2)
				{
					fprintf(stderr, "Data > ");
					fscanf(stdin, "%s", bss_var);
					fprintf(stderr,"Done\n");
				}
				else if(select_num_2 == 3)
				{
					break;
				}
				else
				{
					fprintf(stderr, "Pardon?\n");
					continue;
				}
			}


		}
		else if(select_num == 3)
		{
			fprintf(stderr, "<stack_var_1>\nAddress : %018p\nData :\n", &stack_var_1);

			memory_print(stack_var_1, 0x10);
			fprintf(stderr,"\n<end>\n\n");

			fprintf(stderr, "<stack_var_2>\nAddress : %018p\nData :\n", &stack_var_2);
			memory_print(stack_var_2, 0x10);
			fprintf(stderr, "\n<end>\n\n");

			fprintf(stderr,"<stack_ptr>\nAddress : %018p\nData : %018p\n<end>\n\n", &stack_ptr, stack_ptr);

			fprintf(stderr,"1. stack_var_1\n2. stack_var_2\n3. stack_ptr\n4. main menu\nselect > ");

			int select_num_3 = 0;
			fscanf(stdin, "%d", &select_num_3);
			getchar();
			if(select_num_3==1)
			{
				fprintf(stderr, "Data > ");
				fscanf(stdin, "%s", stack_var_1);
				fprintf(stderr, "Done\n");
			}
			else if(select_num_3==2)
			{
				fprintf(stderr,"Data > ");
				fscanf(stdin,"%s",stack_var_2);
				fprintf(stderr,"Done\n");
			}
			else if(select_num_3==3)
			{
				fprintf(stderr,"Data > ");
				fscanf(stdin,"%s",&stack_ptr);
				getchar();
				fprintf(stderr,"Done\n");
			}
			else if(select_num_3=4)
			{
				continue;
			}
			else
			{
				fprintf(stderr,"Pardon?\n");
				continue;
			}
		}
		else if(select_num ==4)
		{
			break;
		}
		else
		{
			fprintf(stderr, "Pardon?\n");
			continue;
		}
	}
}
